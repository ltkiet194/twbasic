{% extends 'shared/base_edu.html' %}
{% block title %} Register {% endblock title %}
{% block content %}
{% load static %}
<style>
  .star-ratings {
    color: #ccc;
    position: relative;
    
    margin: 0;
    padding: 0;
    .fill-ratings {
      padding: 0;
      position: absolute;
      z-index: 1;
      display: block;
      top: 0;
      left: 0;
      overflow: hidden;
      span {
        display: inline-block;
      }
    }
    .empty-ratings {
      padding: 0;
      display: block;
      z-index: 0;
    }
  }
</style>
<div class="container mt-4">
  
  <div class="row">
    <div class="col-lg-12">
      <div class="page-content p-7 dark:bg-[#1e1e1e] bg-slate-200">

        <!-- ***** Game Start ***** -->
        <!-- ***** Featured Start ***** -->
        <div class="row">
          <div class="col-lg-12">
            <div class="feature-banner header-text">
              <div class="row">
                <div class="container px-5 py-5 mx-auto">
                  <div class="mx-auto sm:flex">
                    <div class="flex items-center justify-center lg:w-1/2">
                      <img id="mainImage" class="h-auto max-w-sm transition-all duration-300 border border-gray-200 rounded-lg" src="{% static 'Theme/images/ImageResource/' %}{{ game.imgName }}" alt="image description">
                    </div>
                    <div class="w-full mt-6 lg:w-1/2 lg:pl-10 lg:mt-0">
                      <h2 class="text-sm tracking-widest text-gray-500 title-font"></h2>
                      <h1 class="mb-1 text-3xl font-medium text-gray-900 title-font dark:text-white">{{game.nameGame}}</h1>
                      <div class="flex mb-4">
                        <span class="flex items-center">
                          <div class="text-2xl star-ratings ">
                            <div class="text-yellow-400 fill-ratings" style="width: {{review.RatingAvg}}%;">
                              <span class="inline-block">★★★★★</span>
                            </div>
                            <div class="empty-ratings">
                              <span class="inline-block">★★★★★</span>
                            </div>
                          </div>
                          <span class="ml-3 text-gray-600">{{review.Total}} Reviews</span>
                        </span>
                        <span class="flex py-2 pl-3 ml-3 border-l-2 border-gray-200">
                          <a class="text-gray-500">
                            <svg fill="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24">
                              <path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"></path>
                            </svg>
                          </a>
                          <a class="ml-2 text-gray-500">
                            <svg fill="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24">
                              <path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"></path>
                            </svg>
                          </a>
                          <a class="ml-2 text-gray-500">
                            <svg fill="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24">
                              <path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"></path>
                            </svg>
                          </a>
                        </span>
                      </div>
                      {% include 'game/partial/attribute_product.html' with game=game %}
                      <div class="flex items-center mt-5">
                        <span class="text-2xl font-medium text-gray-900 dark:text-white basis-1/5 title-font">$58.00</span>
                        <span class="text-2xl font-medium text-gray-900 basis-2/5 title-font"></span>
                        <div class="inline-flex basis-2/5">
                          <button id="addToCart" class="flex px-3 py-1 text-white uppercase transition duration-200 ease-in bg-red-400 border-2 rounded-full w-sm hover:bg-red-500 focus:outline-none">
                            Add
                            <svg class="mt-[3px] ml-1 duration-300 ease-in-out fill-current" width="18" height="18" viewbox="0 0 24 24">
                              <path d="M17,18C15.89,18 15,18.89 15,20A2,2 0 0,0 17,22A2,2 0 0,0 19,20C19,18.89 18.1,18 17,18M1,2V4H3L6.6,11.59L5.24,14.04C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42A0.25,0.25 0 0,1 7.17,14.75C7.17,14.7 7.18,14.66 7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.58 17.3,11.97L20.88,5.5C20.95,5.34 21,5.17 21,5A1,1 0 0,0 20,4H5.21L4.27,2M7,18C5.89,18 5,18.89 5,20A2,2 0 0,0 7,22A2,2 0 0,0 9,20C9,18.89 8.1,18 7,18Z" />
                            </svg>
                          </button>
                          <button class="inline-flex items-center justify-center w-10 h-10 p-0 ml-2 text-gray-500">
                            <svg fill="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-10 h-10" viewBox="0 0 24 24">
                              <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"></path>
                            </svg>
                          </button>
                        </div>

                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- **** Featured End ***** -->

        <!-- ***** Most Popular End ***** -->

        <section class="relative dark:bg-slate-700 rounded-xl bg-slate-300">
          <div class="mb-4 ml-3 border-b border-gray-200 dark:border-gray-700">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="default-tab" data-tabs-toggle="#default-tab-content" role="tablist">
              <li class="me-2" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg" id="profile-tab" data-tabs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Description</button>
              </li>
              <li class="me-2" role="presentation">
                <button onclick="LoadReview()"id="btnReviewTab" class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="dashboard-tab" 
                data-tabs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="false">Review</button>
              </li>
              <li class="me-2" role="presentation">
                <button onclick="LoadComment('{{id}}')" class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="settings-tab" 
                data-tabs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Comments</button>
              </li>
              <li role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="contacts-tab" data-tabs-target="#contacts" type="button" role="tab" aria-controls="contacts" aria-selected="false">Contacts</button>
              </li>
            </ul>
          </div>
          <div id="default-tab-content">
            <div class="hidden p-4 rounded-lg" id="profile" role="tabpanel" aria-labelledby="profile-tab">
              <div class="other-games bg-slate-300">
                <div class="lg:inline-flex row">
                  <div class="lg:w-1/2 ">
                    <div class="p-5 heading-section">
                      <h4 class="font-bold">About This Games</h4>
                      {% autoescape off %}
                      {{ game.desGame }}
                      {% endautoescape %}
                    </div>
                  </div>
                  <div class="lg:w-1/2">
                    <div class="p-5 heading-section">
                      <style>
                        .alert-info {
                          border-radius: 20px;
                          padding: 10px;
                          background-color: rgb(223 213 225 / var(--tw-bg-opacity));
                          --bs-alert-border-color: none;
                        }
                      </style>
                      {% autoescape off %}
                      {{ game.requireGame }}
                      {% endautoescape %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
              {% include 'game/partial/rating.html' with id=id review=review %}
            </div>
            <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                {% include 'game/partial/comments.html' with id=id%}
            </div>
            <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="contacts" role="tabpanel" aria-labelledby="contacts-tab">
              <p class="text-sm text-gray-500 dark:text-gray-400">This is some placeholder content the <strong class="font-medium text-gray-800 dark:text-white">Contacts tab's associated content</strong>. Clicking another tab will toggle the visibility of this one for the next. The tab JavaScript swaps classes to control the content visibility and styling.</p>
            </div>
          </div>

        </section>
        <!-- ***** Comment Start ***** -->
        <!-- ***** Comment End ***** -->

        <!-- ***** Gaming Library Start ***** -->
        
        <div class="gaming-library">
          <div class="col-lg-12">

            <div class="heading-section">
              <h4><em>Your Gaming</em> Library</h4>
            </div>
            <div class="item">
              <ul>
                <li><img src="/static/theme/assets/images/game-01.jpg" alt="" class="templatemo-item"></li>
                <li>
                  <h4>Dota 2</h4><span>Sandbox</span>
                </li>
                <li>
                  <h4>Date Added</h4><span>24/08/2036</span>
                </li>
                <li>
                  <h4>Hours Played</h4><span>634 H 22 Mins</span>
                </li>
                <li>
                  <h4>Currently</h4><span>Downloaded</span>
                </li>
                <li>
                  <div class="main-border-button border-no-active"><a href="#">Donwloaded</a></div>
                </li>
              </ul>
            </div>
            <div class="item">
              <ul>
                <li><img src="/static/theme/assets/images/game-02.jpg" alt="" class="templatemo-item"></li>
                <li>
                  <h4>Fortnite</h4><span>Sandbox</span>
                </li>
                <li>
                  <h4>Date Added</h4><span>22/06/2036</span>
                </li>
                <li>
                  <h4>Hours Played</h4><span>740 H 52 Mins</span>
                </li>
                <li>
                  <h4>Currently</h4><span>Downloaded</span>
                </li>
                <li>
                  <div class="main-border-button"><a href="#">Donwload</a></div>
                </li>
              </ul>
            </div>
            <div class="item last-item">
              <ul>
                <li><img src="/static/theme/assets/images/game-03.jpg" alt="" class="templatemo-item"></li>
                <li>
                  <h4>CS-GO</h4><span>Sandbox</span>
                </li>
                <li>
                  <h4>Date Added</h4><span>21/04/2036</span>
                </li>
                <li>
                  <h4>Hours Played</h4><span>892 H 14 Mins</span>
                </li>
                <li>
                  <h4>Currently</h4><span>Downloaded</span>
                </li>
                <li>
                  <div class="main-border-button border-no-active"><a href="#">Donwloaded</a></div>
                </li>
              </ul>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="main-button">
              <a href="profile.html">View Your Library</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
    </div>
    {% include 'home/footer.html' %}

  </div>

</div>
<script>
  function renderReview(reviews){
    $("#containerReview").empty(); // Di chuyển để chỉ gọi một lần ngoài vòng lặp
    reviews.forEach(review => { // Sử dụng forEach thay vì for để lặp qua mảng
      let star = "";
      for (let i = 1; i < 6; i++) {
          let fillColor = review.Rating < i ? "#FFFFFF" : "#FBBF24";
          star += `<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
                    <g clip-path="url(#clip0_13624_2892)">
                      <path d="M14.1033 2.56698C14.4701 1.82374 15.5299 1.82374 15.8967 2.56699L19.1757 9.21093C19.3214 9.50607 19.6029 9.71064 19.9287 9.75797L27.2607 10.8234C28.0809 10.9426 28.4084 11.9505 27.8149 12.5291L22.5094 17.7007C22.2737 17.9304 22.1662 18.2614 22.2218 18.5858L23.4743 25.8882C23.6144 26.7051 22.7569 27.3281 22.0233 26.9424L15.4653 23.4946C15.174 23.3415 14.826 23.3415 14.5347 23.4946L7.9767 26.9424C7.24307 27.3281 6.38563 26.7051 6.52574 25.8882L7.7782 18.5858C7.83384 18.2614 7.72629 17.9304 7.49061 17.7007L2.1851 12.5291C1.59159 11.9505 1.91909 10.9426 2.73931 10.8234L10.0713 9.75797C10.3971 9.71064 10.6786 9.50607 10.8243 9.21093L14.1033 2.56698Z" 
                      fill="${fillColor}" />
                    </g>
                    <defs>
                      <clipPath id="clip0_13624_2892">
                        <rect width="30" height="30" fill="white" />
                      </clipPath>
                    </defs>
                  </svg>`;
      }
        let dateFormat = formatDate(review.DateReview);
        const newMember = $(`
        <div class="pb-8 border-b border-gray-100 pt-11 max-xl:max-w-2xl max-xl:mx-auto">
          <div class="flex items-center gap-3 mb-4">
            ${star}
          </div>
          <div class="flex sm:items-center flex-col min-[400px]:flex-row justify-between gap-5 mb-4">
            <div class="flex items-center gap-3">
              <img src="/static/avatar/${review.UserName}.png" alt="John image" class="w-8 h-8">
              <h6 class="text-lg font-semibold leading-8 text-indigo-500 ">@${review.UserName}</h6>
            </div>
            <p class="text-lg font-normal leading-8 text-gray-400">${dateFormat} </p>
          </div>
          <p class="text-lg font-normal leading-8 text-gray-400 max-xl:text-justify">${review.Comment} </p>
        </div>
        `);
        $("#containerReview").append(newMember);
    });
  }

  function SetNumberOfReview(rating, ratingAvg, total) {
    console.log(rating["1"]);
    $("#p1Star").text(rating["1"]);
    $("#p2Star").text(rating["2"]);
    $("#p3Star").text(rating["3"]);
    $("#p4Star").text(rating["4"]);
    $("#p5Star").text(rating["5"]);
    $("#pTotalRating").text(total + " Ratings");
    $("#h2AvgRating").text(ratingAvg);

    
    for(let i = 1; i<6 ;i++){
      let percent = (rating[i]/total)*100
      $(`#span${i}Star`).css("width", `${percent}%`);
    }
  }

  function LoadReview() {
    $.ajax({
      type: "GET",
      url: `{% url 'api_get_rating_by_id' id %}`,
      success: function(response , status) {
        console.log(response)
        SetNumberOfReview(response.data.Rating ,response.data.RatingAvg ,response.data.Total)
        renderReview(response.data.ListReview)
        console.log(">>>> Check respone",response )
      },
      error: function(xhr, status, error) {
        // Xử lý lỗi (nếu có)
        //ToastNotification("xhr.responseText","info")
      }
    });
  }
  $(document).ready(function() {
    $(".replybtn").click(function() {
      // Find the nearest comment section to the clicked reply button
      var commentSection = $(this).closest("ul").find(".comment");
      // Toggle the visibility of the comment section
      commentSection.toggleClass("hidden");
    });
  });



  function getRating(){
    const ratingInputs = document.getElementsByName('rating');

    let ratingValue = null;
    ratingInputs.forEach(input => {
        if (input.checked) {
            ratingValue = input.value;
        }
    });
    return ratingValue
}
$("#btnRating").click(function(e) {
  e.preventDefault();
  let value = getRating();
  let text = $('#textReview').val();
  let formData = {
    rating: value,
    comment: text,
    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
  }; 
  if (value != null && text != '') {
  
    console.log("Form :" ,formData)
    $.ajax({
      type: "POST",
      url: `{% url 'api_get_rating_by_id' id %}`,
      data: formData,
      success: function(response) {
        LoadReview()
      },
      error: function(xhr, status, error) {
        // Xử lý lỗi (nếu có)
        ToastNotification(xhr.responseText,"info")
        
      }
    });
  }
  else{
    ToastNotification("You have to Rating or Comment","warning")
  }
});

</script>

{% endblock content %}